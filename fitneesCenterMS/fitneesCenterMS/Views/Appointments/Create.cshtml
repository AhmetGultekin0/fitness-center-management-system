@model fitneesCenterMS.Models.Appointment

@{
    ViewData["Title"] = "Randevu Al";
}

<style>
    
    .time-slot {
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
    }

        .time-slot:hover:not(.disabled) {
            transform: scale(1.05);
            background-color: #28a745; 
            color: white;
        }

        .time-slot.active {
            background-color: #28a745 !important;
            color: white;
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .time-slot.disabled {
            background-color: #dc3545; 
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
            text-decoration: line-through;
        }
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">📅 Yeni Randevu Oluştur</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Create" id="appointmentForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="mb-3">
                            <label asp-for="TrainerId" class="form-label fw-bold">Antrenör Seç</label>
                            <select asp-for="TrainerId" class="form-control form-select" asp-items="ViewBag.TrainerId" id="trainerSelect">
                                <option value="">-- Lütfen Önce Antrenör Seçin --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ServiceId" class="form-label fw-bold">Hizmet Seç</label>
                            <select asp-for="ServiceId" class="form-control form-select" asp-items="ViewBag.ServiceId"></select>
                            <div class="alert alert-success mt-2 d-none" id="priceAlert">
                                <strong>Tahmini Tutar:</strong> <span id="priceLabel">0</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Tarih Seç</label>
                            <input type="date" id="datePicker" class="form-control" min="@DateTime.Now.ToString("yyyy-MM-dd")" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Saat Aralığı Seç (09:00 - 00:00)</label>
                            <div class="d-flex flex-wrap gap-2 justify-content-center" id="timeSlotsContainer">
                                <div class="alert alert-info w-100 text-center">
                                    Lütfen önce Antrenör ve Tarih seçiniz.
                                </div>
                            </div>
                            <input type="hidden" asp-for="AppointmentDate" id="finalDateTime" required />
                            <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="btnSave" disabled>
                                Randevuyu Onayla ✅
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">İptal</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            const startHour = 9;
            const endHour = 23;

            function loadTimeSlots() {
                var trainerId = $("#trainerSelect").val();
                var selectedDate = $("#datePicker").val();
                var container = $("#timeSlotsContainer");

                if (!trainerId || !selectedDate) {
                    container.html('<div class="alert alert-warning w-100 text-center">Lütfen Antrenör ve Tarih seçiniz.</div>');
                    return;
                }

                container.html('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');

                $.get("/Appointments/GetTakenSlots", { trainerId: trainerId, date: selectedDate }, function (takenHours) {
                    container.empty();

                    for (let i = startHour; i <= endHour; i++) {
                        let isTaken = takenHours.includes(i);
                        let timeLabel = `${i}:00 - ${i + 1}:00`;

                        let btnClass = isTaken ? "btn-outline-danger disabled" : "btn-outline-primary time-slot";
                        let disabledAttr = isTaken ? "disabled" : "";
                        let icon = isTaken ? "❌ Dolu" : "✅ Müsait";

                        let btnHtml = `
                            <button type="button"
                                    class="btn ${btnClass} m-1"
                                    data-hour="${i}"
                                    ${disabledAttr}
                                    style="width: 140px;">
                                <strong>${timeLabel}</strong><br>
                                <small>${icon}</small>
                            </button>
                        `;
                        container.append(btnHtml);
                    }
                });
            }

            $("#trainerSelect, #datePicker").change(function () {
                loadTimeSlots();
                $("#btnSave").prop("disabled", true); 
                $("#finalDateTime").val(""); 
            });

            $(document).on("click", ".time-slot", function () {
                $(".time-slot").removeClass("active").addClass("btn-outline-primary").removeClass("btn-success");

                $(this).addClass("active").removeClass("btn-outline-primary").addClass("btn-success");

                var hour = $(this).data("hour");
                var date = $("#datePicker").val();

                var finalDateStr = `${date}T${hour.toString().padStart(2, '0')}:00:00`;
                $("#finalDateTime").val(finalDateStr);

                $("#btnSave").prop("disabled", false);
            });

            $("#ServiceId").change(function() {

                var text = $("#ServiceId option:selected").text();
                var match = text.match(/\((\d+)\s?₺\)/);
                if (match) {
                    $("#priceLabel").text(match[0]);
                    $("#priceAlert").removeClass("d-none");
                } else {
                    $("#priceAlert").addClass("d-none");
                }
            });

        });
    </script>
}